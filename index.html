<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E' quello in cima?</title>
    <style>
        html {
            height: 100%;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            height: 100%;
            background: linear-gradient(to bottom right, #8f00ff, #f5f5f5);
            background-attachment: fixed;
        }

        #container {
            display: flex;
            width: 100%;
            max-width: 900px;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 10px; /* Spazio tra le colonne */
        }

        #left-img, #right-img {
            width: 30%;
            min-height: 300px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.5); /* Leggero sfondo per vedere il box vuoto */
            border-radius: 8px;
        }

        #center-qa {
            width: 35%;
            text-align: center;
            padding: 0 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
        }

        #left-img img, #right-img img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Mantiene le proporzioni riempiendo il box */
        }
       
        /* Modale */
        #disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #disclaimer-box {
            background: violet;
            padding: 20px;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* --- CLASSI DI FEEDBACK (Spostate FUORI da #disclaimer-box per funzionare ovunque) --- */
        .feedback-success-quote {
            font-style: italic;
            font-size: 1.1em;
            font-family: Georgia, serif;
            border-left: 5px solid green;
            padding-left: 15px;
            margin: 10px auto;
            background-color: rgba(0, 128, 0, 0.1); /* Leggero sfondo verde */
            padding: 10px;
            border-radius: 4px;
        }
        
        .feedback-correct {
            color: green;
            font-weight: bold;
        }
        
        .feedback-error {
            color: red;
            font-weight: bold;
        }

        /* Responsive per cellulari */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #left-img, #right-img, #center-qa {
                width: 90%;
                margin-bottom: 20px;
            }
            #left-img, #right-img {
                min-height: 200px; /* Meno alti su mobile */
            }
        }
    </style>
</head>
<body>

<div id="disclaimer-modal">
    <div id="disclaimer-box">
        <p id="disclaimer-text">Caricamento del disclaimer...</p>
        <button onclick="closeDisclaimer()" style="padding: 10px 20px; cursor: pointer;">OK</button>
    </div>
</div>

<h2 style="color: white; text-shadow: 1px 1px 2px black;">Domanda del Giorno</h2>
<input type="date" id="date-selector" onchange="changeDate()" style="padding: 5px; border-radius: 5px; border: none;" />

<div id="container">
    
    <div id="left-img">Immagine sinistra</div>
    
    <div id="center-qa">
        <h3 id="question">Caricamento...</h3>
        <input type="text" id="answer" placeholder="Scrivi la risposta..." style="padding: 8px; width: 80%; margin-bottom: 10px;" />
        <br>
        <button onclick="checkAnswer()" style="padding: 8px 15px; cursor: pointer;">Invia</button>
        
        <p id="feedback"></p>
        <p style="font-size: 0.8em; color: #555;">Tentativi effettuati: <span id="current-attempts">0</span></p>
    </div>
    
    <div id="right-img"></div>
</div>

<script>
let DATA = {};
let currentDate = "";
// Carica i risultati salvati
let results = JSON.parse(localStorage.getItem("results_domanda_giorno") || "{}");
// AGGIUNTO: Carica i tentativi salvati (Fix Critico)
let attempts = JSON.parse(localStorage.getItem("attempts_domanda_giorno") || "{}");

fetch("Q.json")
    .then(r => {
        if (!r.ok) throw new Error("Errore nel caricamento di Q.json: " + r.statusText);
        return r.json();
    })
    .then(json => {
        DATA = json;
        init();
    })
    .catch(err => {
        console.error("Errore fatale:", err);
        document.getElementById("disclaimer-text").innerText = "Errore nel caricamento dei dati (Q.json). Controlla che il file esista.";
        // Non mostriamo il disclaimer subito in caso di errore fetch per evitare loop se manca il file
    });


function init() {
    const today = new Date();
    const yyyy = today.getFullYear(); 
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    currentDate = `${yyyy}-${mm}-${dd}`;

    document.getElementById("date-selector").value = currentDate;
    loadDay(currentDate);
}

function closeDisclaimer() {
    document.getElementById("disclaimer-modal").style.display = "none";
}

function showDisclaimer() {
    document.getElementById("disclaimer-modal").style.display = "flex";
}

function changeDate() {
    currentDate = document.getElementById("date-selector").value;
    loadDay(currentDate);
}

function loadDay(dateStr) {
    const today = new Date();
    const todayStr = today.getFullYear() + '/' + String(today.getMonth() + 1).padStart(2, '0') + '/' + String(today.getDate()).padStart(2, '0');
    
    const selectedDate = new Date(dateStr.replace(/-/g, '/'));
    const currentDateOnly = new Date(todayStr);
    
    const answerInput = document.getElementById("answer");
    const checkButton = document.querySelector("#center-qa button");
    const feedbackElement = document.getElementById("feedback");
    const questionElement = document.getElementById("question");
    const attemptsSpan = document.getElementById("current-attempts");
    
    // Reset interfaccia
    document.getElementById("left-img").innerHTML = `Immagine sinistra`;
    document.getElementById("right-img").innerHTML = "";
    answerInput.value = "";
    feedbackElement.innerText = "";
    feedbackElement.className = ""; // Rimuove tutte le classi
    
    // Mostra i tentativi attuali per quella data
    attemptsSpan.innerText = attempts[dateStr] || 0;

    // Controllo data futura
    if (selectedDate.getTime() > currentDateOnly.getTime()) {
        answerInput.disabled = true;
        checkButton.disabled = true;
        
        questionElement.innerText = "‚ö†Ô∏è Non puoi visualizzare le domande future.";
        document.getElementById("disclaimer-text").innerText = "Ehi tu, furbetta! Non sbirciare il futuro";
        showDisclaimer();
        
        document.getElementById("left-img").innerHTML = `<div style="text-align:center; padding: 20px;">üìÖ Data Futura</div>`;
        return;
    }
    
    // Riabilita input
    answerInput.disabled = false;
    checkButton.disabled = false;
    
    const data = DATA[dateStr];

    // Immagine sinistra
    document.getElementById("left-img").innerHTML = `<img src="Sx/${dateStr}.jpg" alt="Immagine sx" onerror="this.onerror=null; this.src='Sx/placeholder_sx.jpg'; this.alt='Immagine mancante'">`;

    if (!data) {
        questionElement.innerText = "Nessuna domanda trovata.";
        document.getElementById("disclaimer-text").innerText = "Nessuna domanda trovata per questa data.";
        // showDisclaimer(); // Opzionale: mostrare disclaimer anche se non c'√® domanda
        return;
    }

    // Carica dati
    document.getElementById("disclaimer-text").innerText = data.disclaimer || "Benvenuta!";
    showDisclaimer();
    
    questionElement.innerText = data.question;

    // Se gi√† risolto
    if (results[dateStr] === true) {
        showRightImage(dateStr);
        feedbackElement.innerText = `${data.phrase || "Brava!"}`; // Usa la frase di successo
        feedbackElement.classList.add("feedback-correct", "feedback-success-quote");
        answerInput.disabled = true;
        checkButton.disabled = true;
    }
}

function checkAnswer() {
    const data = DATA[currentDate];

    // Se non ci sono dati o √® gi√† risolto, esci
    if (!data || results[currentDate] === true) {
        return;
    }
    
    // Logica tentativi
    let currentAttempts = attempts[currentDate] || 0;
    currentAttempts++;
    attempts[currentDate] = currentAttempts;
    localStorage.setItem("attempts_domanda_giorno", JSON.stringify(attempts));
    
    // Aggiorna il numero a schermo (ora l'elemento esiste!)
    document.getElementById("current-attempts").innerText = currentAttempts;

    const userAnswer = document.getElementById("answer").value.trim().toLowerCase();
    const correct = data.answer.toString().trim().toLowerCase();

    const feedbackElement = document.getElementById("feedback");
    const answerInput = document.getElementById("answer");
    const checkButton = document.querySelector("#center-qa button");

    if (userAnswer === correct) {
        // CORRETTO
        feedbackElement.innerText = `${data.phrase} (Risolta in ${currentAttempts} tentativi!)`;
        feedbackElement.className = "feedback-correct feedback-success-quote"; // Sovrascrive classi
        
        results[currentDate] = true;
        localStorage.setItem("results_domanda_giorno", JSON.stringify(results));
        showRightImage(currentDate);
        
        answerInput.disabled = true;
        checkButton.disabled = true;
    } else {
        // ERRATO
        feedbackElement.innerText = `Risposta errata. Riprova!`;
        feedbackElement.className = "feedback-error"; // Sovrascrive classi
    }
}

function showRightImage(dateStr) {
    document.getElementById("right-img").innerHTML = `<img src="Dx/${dateStr}.jpg" alt="Immagine dx" onerror="this.onerror=null; this.src='Dx/placeholder_dx.jpg'; this.alt='Immagine mancante'">`;
}
</script>

</body>
</html>
