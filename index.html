<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E' quello in cima?</title>
    <style>

        html {
        height: 100%;
        }
        
        body {
           font-family: Arial, sans-serif;
            margin: 0; 
            
            /* CENTRAGGIO VERTICALE */
            display: flex;
            flex-direction: column; 
            align-items: center;    
            justify-content: center;  
            min-height: 100vh;      
            height: 100%; 
        
            /* I TUOI COLORI ORIGINALI */
            background: linear-gradient(to bottom right, #8f00ff, #f5f5f5);
            background-attachment: fixed;
        }
        #container {
            display: flex; 
            width: 100%;
            max-width: 900px;
            justify-content: space-between; 
            align-items: center;
            margin-top: 20px;
        }
        #left-img, #right-img {
            width: 30%; 
            min-height: 300px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: rgba(255,255,255,0.3); /* Leggero sfondo per vedere il box */
        }
        #center-qa {
            width: 35%; 
            text-align: center;
            padding: 0 10px; 
        }
        #left-img img, #right-img img {
            width: 100%;
        }
       
        /* MODALE */
        #disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none; /* Nascosto di default, gestito da JS */
            justify-content: center;
            align-items: center;
            z-index: 1000; 
        }
        #disclaimer-box {
            background: violet;
            padding: 20px;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
        }

        /* CORREZIONE CSS: Queste classi devono stare FUORI da #disclaimer-box */
        .feedback-success-quote {
            font-style: italic; 
            font-size: 1.1em;   
            font-family: Georgia, serif; 
            border-left: 5px solid green; 
            padding-left: 15px; 
            margin: 10px auto; 
            background: rgba(255,255,255,0.5); /* Aggiunto sfondo per leggibilit√† */
        }
        
        .feedback-correct {
            color: darkgreen; /* Verde pi√π scuro per contrasto */
            font-weight: bold;
        }
        .feedback-error {
            color: darkred; /* Rosso pi√π scuro per contrasto */
            font-weight: bold;
        }
        
        /* Responsive base per mobile */
        @media (max-width: 600px) {
            #container { flex-direction: column; }
            #left-img, #right-img, #center-qa { width: 90%; margin-bottom: 15px; }
        }

    </style>
</head>
<body>

<div id="disclaimer-modal">
    <div id="disclaimer-box">
        <p id="disclaimer-text">Caricamento del disclaimer...</p>
        <button onclick="closeDisclaimer()" style="padding: 5px 15px; cursor: pointer;">OK</button>
    </div>
</div>

<h2 style="color: white; text-shadow: 1px 1px 2px black;">Domanda del Giorno</h2>
<input type="date" id="date-selector" onchange="changeDate()" style="padding: 5px;" />

<div id="container">
    
    <div id="left-img">Immagine sinistra</div>
    
    <div id="center-qa">
        <h3 id="question">Caricamento...</h3>
        <input type="text" id="answer" placeholder="Risposta" style="padding: 5px; width: 80%;" />
        <br><br>
        <button onclick="checkAnswer()" style="cursor: pointer; padding: 5px 10px;">Invia</button>
        
        <p id="feedback"></p>
        <p style="font-size: 0.8em; color: #333;">Tentativi: <span id="current-attempts">0</span></p>
    </div>
    
    <div id="right-img"></div>
</div>

<script>
// --- VARIABILI GLOBALI ---
let DATA = {};
let currentDate = "";
let results = JSON.parse(localStorage.getItem("results_domanda_giorno") || "{}");
// FIX: Inizializziamo correttamente attempts
let attempts = JSON.parse(localStorage.getItem("attempts_domanda_giorno") || "{}");

// --- CARICAMENTO DATI ---
fetch("Q.json")
    .then(r => {
        if (!r.ok) throw new Error("Errore nel caricamento di Q.json: " + r.statusText);
        return r.json();
    })
    .then(json => {
        DATA = json;
        init();
    })
    .catch(err => {
        console.error("Errore fatale:", err);
        document.getElementById("question").innerText = "Errore: file Q.json non trovato.";
    });

function init() {
    // Calcoliamo la data di oggi in formato YYYY-MM-DD locale
    const today = new Date();
    const yyyy = today.getFullYear(); 
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    currentDate = `${yyyy}-${mm}-${dd}`;

    document.getElementById("date-selector").value = currentDate;
    loadDay(currentDate);
}

function closeDisclaimer() {
    document.getElementById("disclaimer-modal").style.display = "none";
}

function showDisclaimer() {
    document.getElementById("disclaimer-modal").style.display = "flex";
}

function changeDate() {
    currentDate = document.getElementById("date-selector").value;
    loadDay(currentDate);
}

function loadDay(dateStr) {
    // 1. OTTENIAMO LA DATA DI OGGI COME STRINGA PER CONFRONTO SICURO
    const todayObj = new Date();
    const todayStr = todayObj.getFullYear() + '-' + String(todayObj.getMonth() + 1).padStart(2, '0') + '-' + String(todayObj.getDate()).padStart(2, '0');
    
    // Riferimenti DOM
    const answerInput = document.getElementById("answer");
    const checkButton = document.querySelector("#center-qa button");
    const feedbackElement = document.getElementById("feedback");
    const questionElement = document.getElementById("question");
    const attemptsDisplay = document.getElementById("current-attempts");
    
    // 2. RESET TOTALE INTERFACCIA (IMPORTANTE: Sblocca tutto prima di controllare)
    document.getElementById("left-img").innerHTML = `Immagine sinistra`; 
    document.getElementById("right-img").innerHTML = "";
    answerInput.value = "";
    answerInput.disabled = false; // <--- SBLOCCO FONDAMENTALE
    checkButton.disabled = false; // <--- SBLOCCO FONDAMENTALE
    feedbackElement.innerText = "";
    feedbackElement.className = ""; // Rimuove classi verde/rosso
    
    // Mostra tentativi salvati o 0
    attemptsDisplay.innerText = attempts[dateStr] || 0;
       
    // 3. CONTROLLO DATA FUTURA (Confronto stringhe: "2025-12-11" > "2025-12-10")
    if (dateStr > todayStr) {
        answerInput.disabled = true;
        checkButton.disabled = true;
        
        questionElement.innerText = "‚ö†Ô∏è Non puoi visualizzare le domande future.";
        document.getElementById("disclaimer-text").innerText = "Ehi tu, furbetta! Non sbirciare il futuro";
        showDisclaimer();
        
        document.getElementById("left-img").innerHTML = `<div style="text-align:center; padding: 20px;">üìÖ Data Futura</div>`;
        return; 
    }
    
    // 4. CARICAMENTO DOMANDA
    const data = DATA[dateStr];

    // Immagine sinistra
    document.getElementById("left-img").innerHTML = `<img src="Sx/${dateStr}.jpg" alt="Sx" onerror="this.parentNode.innerText='Foto mancante'">`;

    if (!data) {
        questionElement.innerText = "Nessuna domanda trovata per oggi.";
        // Non mostriamo disclaimer se non c'√® la domanda, o mostriamo un avviso generico
        return;
    }

    // Carica Disclaimer e Domanda
    document.getElementById("disclaimer-text").innerText = data.disclaimer || "Benvenuta!";
    showDisclaimer();
    
    questionElement.innerText = data.question;

    // 5. CONTROLLO SE GIA RISOLTA
    if (results[dateStr] === true) {
        showRightImage(dateStr);
        feedbackElement.innerText = `${data.phrase} (Risolto!)`;
        feedbackElement.className = "feedback-correct feedback-success-quote";
        
        // Solo ORA blocchiamo l'input perch√© √® gi√† risolta
        answerInput.disabled = true;
        checkButton.disabled = true;
    }
}

function checkAnswer() {
    const data = DATA[currentDate];

    // Se non ci sono dati o √® gi√† risolto, esci
    if (!data || results[currentDate] === true) {
        return;
    }
    
    // Incremento tentativi
    let currentAttempts = attempts[currentDate] || 0;
    currentAttempts++;
    attempts[currentDate] = currentAttempts;
    localStorage.setItem("attempts_domanda_giorno", JSON.stringify(attempts));
    
    document.getElementById("current-attempts").innerText = currentAttempts;

    const userAnswer = document.getElementById("answer").value.trim().toLowerCase();
    const correct = data.answer.toString().trim().toLowerCase();

    const feedbackElement = document.getElementById("feedback");
    const answerInput = document.getElementById("answer");
    const checkButton = document.querySelector("#center-qa button");

    if (userAnswer === correct) {
        // --- CORRETTO ---
        feedbackElement.innerText = `${data.phrase} (Brava! ${currentAttempts} tentativi)`;
        feedbackElement.className = "feedback-correct feedback-success-quote"; // Applica stile verde/citazione

        results[currentDate] = true;
        localStorage.setItem("results_domanda_giorno", JSON.stringify(results));
        showRightImage(currentDate);
        
        // Disabilita i campi DOPO la risposta corretta
        answerInput.disabled = true;
        checkButton.disabled = true;
    } else {
        // --- ERRATO ---
        feedbackElement.innerText = `Risposta errata. Riprova!`;
        feedbackElement.className = "feedback-error"; // Applica stile rosso
    }
}

function showRightImage(dateStr) {
    document.getElementById("right-img").innerHTML = `<img src="Dx/${dateStr}.jpg" alt="Dx" onerror="this.parentNode.innerText='Foto mancante'">`;
}
</script>

</body>
</html>
